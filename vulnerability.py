import os
import sys

def main():

    # Public-facing buckets
    buckets_cmd = "gsutil ls | while read bucket; do gsutil iam get $bucket | grep -q allUsers && echo $bucket; done"
    buckets_output = os.popen(buckets_cmd).read().strip()

    # Instances that use default service accounts
    instances_cmd = 'gcloud compute instances list --format="value(name,zone,serviceAccounts.email)" | grep -E ".*compute.*@.*" | grep -v -E ".*@.*\..*\.gserviceaccount\.com" | while read name zone service_account; do echo "Instance: $name, Zone: $zone, Service Account: $service_account"; done'
    instances_output = os.popen(instances_cmd).read().strip()

    # Vulnerable firewall rules
    firewall_cmd = 'gcloud compute firewall-rules list --filter="NOT ALLOW:22 NOT ALLOW:443 NOT ALLOW:icmp" --format="table(NAME,NETWORK,ALLOW)"'
    firewall_output = os.popen(firewall_cmd).read().strip()

    # Save results in HTML and CSV formats
    html_file_path = os.path.join(os.path.dirname(os.path.abspath(sys.argv[0])), 'templates', 'vulnerability.html')
    with open(html_file_path, 'w') as f:
        f.write('<head>')
        f.write('<link rel="stylesheet" href="static/styles.css">')
        f.write('</head>')        
        f.write('<h2>Public-facing buckets:</h2>')
        f.write(f'<pre>{buckets_output}</pre>')
        f.write('<h2>Instances that use default service accounts:</h2>')
        f.write(f'<pre>{instances_output}</pre>')
        f.write('<h2>Vulnerable firewall rules:</h2>')
        f.write(f'<pre>{firewall_output}</pre>')
        

    csv_file_path = os.path.join(os.path.dirname(os.path.abspath(sys.argv[0])), 'csv', 'vulnerabilities.csv')
    with open(csv_file_path, 'w') as f:
        f.write('Public-facing buckets:\n')
        f.write(f'{buckets_output}\n')
        f.write('Instances that use default service accounts:\n')
        f.write(f'{instances_output}\n')
        f.write('Vulnerable firewall rules:\n')
        f.write(f'{firewall_output}\n')


if __name__ == '__main__':
    main()